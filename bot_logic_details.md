# Олимпиадный портал Telegram Бот: Детальное описание логики

## 1. Структура Базы Данных (SQLite)

-   **Olympiads**:
    -   `id`: INTEGER PRIMARY KEY AUTOINCREMENT - Уникальный идентификатор олимпиады.
    -   `name`: TEXT NOT NULL - Название олимпиады.
    -   `date`: TEXT NOT NULL - Дата проведения олимпиады (формат ГГГГ-ММ-ДД).
    -   `subject`: TEXT - Предмет олимпиады.
    -   `description`: TEXT - Краткое описание олимпиады.
-   **Users**:
    -   `telegram_id`: INTEGER PRIMARY KEY - Уникальный Telegram ID пользователя.
    -   `snils`: TEXT UNIQUE - СНИЛС пользователя (для идентификации и привязки результатов). Может быть NULL, если пользователь еще не указал.
    -   `is_admin`: BOOLEAN DEFAULT 0 - Флаг, указывающий, является ли пользователь администратором (0 - нет, 1 - да).
-   **Results**:
    -   `id`: INTEGER PRIMARY KEY AUTOINCREMENT - Уникальный идентификатор результата.
    -   `olympiad_id`: INTEGER NOT NULL - ID олимпиады (внешний ключ к Olympiads.id).
    -   `user_snils`: TEXT NOT NULL - СНИЛС участника, к которому относится результат.
    -   `full_name`: TEXT NOT NULL - ФИО участника.
    -   `score`: INTEGER - Набранные баллы.
    -   `place`: INTEGER - Занятое место.
    -   `diploma_link`: TEXT - Ссылка на диплом (если есть).
    -   FOREIGN KEY (`olympiad_id`) REFERENCES `Olympiads` (`id`)

## 2. Логика работы команд Telegram-бота

### 2.1. Общие команды (доступны всем)

-   **/start**
    -   **Логика**: Приветствует пользователя. Проверяет, есть ли пользователь в таблице `Users`. Если нет, добавляет с `telegram_id` и `is_admin=0`.
    -   **Сообщение**: "Добро пожаловать в Олимпиадный Портал! Чтобы просматривать свои результаты, пожалуйста, привяжите ваш СНИЛС с помощью команды `/mydata`. Для списка команд введите `/help`."
    -   **Обработка ошибок**: Стандартная обработка ошибок Telegram.

-   **/help**
    -   **Логика**: Отображает список доступных команд для пользователя и администратора (если пользователь является администратором).
    -   **Сообщение (для обычного пользователя)**:
        ```
        Доступные команды:
        /start - Начало работы
        /help - Эта помощь
        /mydata - Привязать или изменить ваш СНИЛС
        /myresults - Посмотреть ваши результаты олимпиад
        /listolympiads - Посмотреть список всех олимпиад
        ```
    -   **Сообщение (для администратора добавляется)**:
        ```
        Команды администратора:
        /admin_add_olympiad - Добавить новую олимпиаду
        /admin_add_results - Добавить результаты олимпиады
        /admin_edit_result - Редактировать результат олимпиады
        ```
    -   **Обработка ошибок**: Стандартная обработка ошибок Telegram.

-   **/mydata**
    -   **Логика**: Позволяет пользователю привязать или изменить свой СНИЛС. Бот запрашивает СНИЛС. После ввода СНИЛС сохраняется/обновляется в таблице `Users` для `telegram_id` пользователя. Валидация формата СНИЛС (XXX-XXX-XXX XX).
    -   **Сценарий**:
        1.  Пользователь вводит `/mydata`.
        2.  Бот: "Пожалуйста, введите ваш СНИЛС в формате XXX-XXX-XXX XX. Этот СНИЛС будет использоваться для поиска ваших результатов."
        3.  Пользователь вводит СНИЛС.
        4.  Бот проверяет формат. Если неверный: "Неверный формат СНИЛС. Пожалуйста, введите в формате XXX-XXX-XXX XX."
        5.  Если формат верный: Бот пытается обновить/вставить СНИЛС в `Users`. Если СНИЛС уже занят другим `telegram_id`: "Этот СНИЛС уже привязан к другому аккаунту. Обратитесь к администратору."
        6.  Успех: "Ваш СНИЛС [СНИЛС] успешно сохранен/обновлен."
    -   **Обработка ошибок**: Неверный формат СНИЛС, СНИЛС уже используется, ошибка БД.

-   **/myresults**
    -   **Логика**: Отображает результаты пользователя во всех олимпиадах. Сначала проверяет, привязан ли СНИЛС к `telegram_id` пользователя в таблице `Users`. Если нет, просит использовать `/mydata`. Если СНИЛС есть, ищет все записи в `Results` по `user_snils` и выводит информацию, объединяя с данными из `Olympiads`.
    -   **Сценарий**:
        1.  Пользователь вводит `/myresults`.
        2.  Бот проверяет наличие СНИЛС для `telegram_id`.
        3.  Если СНИЛС не найден: "Сначала привяжите ваш СНИЛС с помощью команды `/mydata`."
        4.  Если СНИЛС найден: Бот выполняет запрос к БД.
        5.  Если результатов нет: "Результаты для СНИЛС [СНИЛС] не найдены."
        6.  Если результаты есть, выводит списком:
            ```
            Ваши результаты (СНИЛС: [СНИЛС]):
            
            Олимпиада: [Название олимпиады 1] ([Дата])
            Предмет: [Предмет]
            ФИО: [ФИО]
            Баллы: [Баллы]
            Место: [Место]
            Диплом: [Ссылка или 'Нет']
            --------------------
            Олимпиада: [Название олимпиады 2] ([Дата])
            ...
            ```
    -   **Обработка ошибок**: СНИЛС не привязан, ошибка БД.

-   **/listolympiads**
    -   **Логика**: Отображает список всех олимпиад из таблицы `Olympiads`.
    -   **Сценарий**:
        1.  Пользователь вводит `/listolympiads`.
        2.  Бот выполняет запрос к БД.
        3.  Если олимпиад нет: "Пока нет доступных олимпиад."
        4.  Если олимпиады есть, выводит списком:
            ```
            Список доступных олимпиад:
            
            1. Название: [Название олимпиады 1]
               Дата: [Дата]
               Предмет: [Предмет]
               Описание: [Описание]
            --------------------
            2. Название: [Название олимпиады 2]
               ...
            ```
    -   **Обработка ошибок**: Ошибка БД.

### 2.2. Команды администратора (требуется `is_admin=1`)

Перед выполнением любой администраторской команды, бот проверяет флаг `is_admin` для `telegram_id` пользователя. Если `is_admin=0`, бот отвечает: "У вас нет прав для выполнения этой команды."

-   **/admin_add_olympiad**
    -   **Логика**: Позволяет администратору добавить новую олимпиаду. Бот последовательно запрашивает: Название, Дату (ГГГГ-ММ-ДД), Предмет, Описание. После получения всех данных, создает новую запись в `Olympiads`.
    -   **Сценарий (FSM - Finite State Machine)**:
        1.  Админ вводит `/admin_add_olympiad`.
        2.  Бот: "Введите название олимпиады:"
        3.  Админ: [Название]
        4.  Бот: "Введите дату проведения (ГГГГ-ММ-ДД):"
        5.  Админ: [Дата]
        6.  Бот (валидация даты): Если неверный формат, просит ввести снова.
        7.  Бот: "Введите предмет олимпиады (или '-' если нет):"
        8.  Админ: [Предмет]
        9.  Бот: "Введите краткое описание олимпиады (или '-' если нет):"
        10. Админ: [Описание]
        11. Бот: "Олимпиада '[Название]' успешно добавлена."
    -   **Обработка ошибок**: Неверный формат даты, ошибка БД.

-   **/admin_add_results**
    -   **Логика**: Позволяет администратору добавить результаты для существующей олимпиады. Сначала бот предлагает выбрать олимпиаду из списка (или ввести ID). Затем запрашивает данные по каждому участнику: ФИО, СНИЛС, баллы, место, ссылка на диплом. Предусмотреть возможность отмены или завершения ввода.
    -   **Сценарий (FSM)**:
        1.  Админ вводит `/admin_add_results`.
        2.  Бот: "Выберите олимпиаду для добавления результатов (введите ID из списка ниже или 0 для отмены):"
            (Выводит список олимпиад с ID)
        3.  Админ: [ID олимпиады]
        4.  Бот (проверка ID): Если ID не существует или 0, выход.
        5.  Бот: "Добавление результатов для олимпиады: [Название олимпиады]. Введите данные участника."
        6.  Бот: "ФИО участника (или 'стоп' для завершения):"
        7.  Админ: [ФИО]
        8.  Если 'стоп', завершить ввод для этой олимпиады.
        9.  Бот: "СНИЛС участника (XXX-XXX-XXX XX):"
        10. Админ: [СНИЛS]
        11. Бот (валидация СНИЛС).
        12. Бот: "Набранные баллы:"
        13. Админ: [Баллы]
        14. Бот (валидация, что это число).
        15. Бот: "Занятое место:"
        16. Админ: [Место]
        17. Бот (валидация, что это число).
        18. Бот: "Ссылка на диплом (или '-' если нет):"
        19. Админ: [Ссылка]
        20. Бот: "Результат для [ФИО] добавлен. Введите ФИО следующего участника (или 'стоп'):"
        21. Переход к п.7.
    -   **Обработка ошибок**: Неверный ID олимпиады, неверный формат данных, ошибка БД.
    -   **Альтернатива**: Предложить загрузку CSV файла с результатами (более сложная реализация для бота, но удобнее для массового ввода).

-   **/admin_edit_result**
    -   **Логика**: Позволяет администратору редактировать существующий результат. Сначала запрашивает ID результата или СНИЛС участника и ID олимпиады для поиска. После нахождения результата, предлагает выбрать поле для редактирования и ввести новое значение.
    -   **Сценарий (FSM)**:
        1.  Админ вводит `/admin_edit_result`.
        2.  Бот: "Введите ID результата, который хотите отредактировать (или 0 для поиска по СНИЛС+Олимпиада):"
        3.  Админ: [ID результата]
        4.  Если ID > 0: Бот ищет результат. Если не найден: "Результат с ID [ID] не найден."
        5.  Если ID == 0: Бот: "Введите СНИЛС участника:" Админ: [СНИЛС]. Бот: "Введите ID олимпиады:" Админ: [ID Олимпиады]. Бот ищет.
        6.  Если результат найден, бот выводит текущие данные:
            "Найден результат:
            Олимпиада: [Название]
            ФИО: [ФИО]
            СНИЛС: [СНИЛС]
            Баллы: [Баллы]
            Место: [Место]
            Диплом: [Ссылка]
            
            Какое поле вы хотите изменить? (фио, снилс, баллы, место, диплом, отмена)"
        7.  Админ: [название поля]
        8.  Если 'отмена', выход.
        9.  Бот: "Введите новое значение для '[название поля]':"
        10. Админ: [новое значение]
        11. Бот (валидация значения в зависимости от поля).
        12. Бот обновляет запись в `Results`.
        13. Бот: "Поле '[название поля]' успешно обновлено. Хотите изменить что-то еще в этом результате? (да/нет)"
        14. Если 'да', переход к п.6. Если 'нет', выход.
    -   **Обработка ошибок**: Результат не найден, неверный ввод, ошибка БД.

## 3. Логика работы API для добавления результатов

-   **Endpoint**: `/api/v1/results`
-   **Method**: `POST`
-   **Authentication**: API Key передается в заголовке `X-API-KEY`. Ключ должен быть заранее сгенерирован и известен администратору/системе, которая будет использовать API. Проверка ключа происходит на стороне API.
-   **Request Body (JSON)**:
    ```json
    {
      "olympiad_id": 123,
      "results": [
        {
          "full_name": "Иванов Иван Иванович",
          "snils": "123-456-789 00",
          "score": 85,
          "place": 1,
          "diploma_link": "http://example.com/diploma/1.pdf"
        },
        {
          "full_name": "Петров Петр Петрович",
          "snils": "987-654-321 11",
          "score": 70,
          "place": 2,
          "diploma_link": null
        }
      ]
    }
    ```
-   **Логика работы API**:
    1.  Получить POST-запрос на `/api/v1/results`.
    2.  Проверить наличие и валидность `X-API-KEY` в заголовках. Если ключ неверный или отсутствует, вернуть `401 Unauthorized`.
    3.  Распарсить JSON из тела запроса.
    4.  Проверить наличие `olympiad_id` и что олимпиада с таким ID существует в таблице `Olympiads`. Если нет, вернуть `404 Not Found` ("Olympiad not found").
    5.  Проверить наличие массива `results`. Если пустой, вернуть `400 Bad Request` ("Results array is empty").
    6.  Для каждого объекта в массиве `results`:
        a.  Проверить наличие обязательных полей: `full_name`, `snils`, `score`, `place`.
        b.  Проверить формат СНИЛС.
        c.  Проверить типы данных для `score` (integer) и `place` (integer).
        d.  Если какое-либо поле отсутствует или имеет неверный формат/тип, собрать информацию об ошибке.
    7.  Если есть ошибки валидации в данных результатов, вернуть `400 Bad Request` с описанием ошибок.
        Пример:
        ```json
        {
          "error": "Validation failed",
          "details": [
            { "index": 0, "field": "snils", "message": "Invalid SNILS format" },
            { "index": 1, "field": "score", "message": "Must be an integer" }
          ]
        }
        ```
    8.  Если все данные валидны: для каждого результата в массиве создать новую запись в таблице `Results`, связывая с `olympiad_id`.
    9.  Если все записи успешно добавлены, вернуть `201 Created` с сообщением о успехе.
        Пример:
        ```json
        {
          "message": "Results added successfully",
          "added_count": 2
        }
        ```
    10. В случае ошибки БД при добавлении, вернуть `500 Internal Server Error`.

-   **Генерация API ключа**: Вне рамок API. Администратор должен иметь возможность сгенерировать/получить ключ (например, через специальную команду бота для админа или вручную в БД).

## 4. Пользовательские сценарии и обработка ошибок (Общее)

-   **Недоступность БД**: Все операции с БД должны быть обернуты в try-except блоки. При ошибке БД, бот должен сообщать пользователю о временных технических проблемах.
-   **Некорректный ввод**: Для всех запросов данных от пользователя (СНИЛС, даты, числа) должна быть валидация. При некорректном вводе, бот должен вежливо просить повторить ввод, указывая на ошибку.
-   **Отмена операций**: Для многошаговых операций (добавление олимпиады, результатов) предусмотреть команду отмены (например, ввод 'отмена' или специальная кнопка).
-   **Права доступа**: Четкое разделение команд для обычных пользователей и администраторов. Проверка прав перед выполнением каждой административной команды.
-   **Обратная связь**: Бот должен давать понятную обратную связь на все действия пользователя: успех, ошибка, что ожидается дальше.

Эта детальная проработка логики поможет на следующих этапах реализации.
