# Олимпиадный портал Telegram Бот: План разработки

## Шаг 1: Уточнение требований (Завершено)

- [x] Задать вопросы пользователю для уточнения требований.
- [x] Получить ответы на все вопросы.

## Шаг 2: Проектирование структуры данных и функций бота (В процессе)

- [x] Определить структуру таблиц базы данных SQLite:
    - **Olympiads**: `id` (PK), `name`, `date`, `subject`, `description`
    - **Users**: `telegram_id` (PK), `snils` (UNIQUE), `is_admin`
    - **Results**: `id` (PK), `olympiad_id` (FK), `user_snils`, `full_name`, `score`, `place`, `diploma_link`
- [x] Спроектировать основные команды бота для пользователей:
    - `/start` - Начало работы, приветствие, инструкция по привязке СНИЛС.
    - `/help` - Помощь по командам.
    - `/mydata` - Привязка/изменение СНИЛС пользователя к его Telegram ID.
    - `/myresults` - Просмотр своих результатов по привязанному СНИЛС во всех олимпиадах.
    - `/listolympiads` - Просмотр списка всех доступных олимпиад.
- [x] Спроектировать команды бота для администраторов (проверка `is_admin`):
    - `/admin` - (Опционально) Панель администратора.
    - `/admin_add_olympiad` - Добавление новой олимпиады (пошаговый ввод данных).
    - `/admin_add_results` - Добавление результатов для выбранной олимпиады (пошаговый ввод данных по каждому участнику или предложение формата для массовой загрузки, например, CSV).
    - `/admin_edit_result` - Редактирование существующих результатов (поиск по ID результата или связке СНИЛС+Олимпиада).
- [x] Определить спецификацию API для добавления результатов:
    - **Endpoint**: `/api/v1/results`
    - **Method**: `POST`
    - **Authentication**: API Key в заголовке (`X-API-KEY`)
    - **Request Body (JSON)**: `{ "olympiad_id": int, "results": [{"full_name": str, "snils": str, "score": int, "place": int, "diploma_link": str}] }`
    - **Responses**: Success (201), Error (400, 401, 404, 500) с JSON-описанием.
- [x] Создать детальное описание логики работы каждой функции и команды, включая обработку ошибок и пользовательские сценарии.

## Шаг 3: Реализация ядра Telegram-бота

- [x] Настроить окружение для разработки бота (Python, aiogram или python-telegram-bot, SQLite).
- [x] Реализовать подключение к базе данных SQLite и создание таблиц при первом запуске.
- [x] Реализовать обработчики для базовых команд (`/start`, `/help`).
- [ ] Реализовать команды для пользователей:
    - [x] `/mydata` (сохранение/обновление СНИЛС в таблице Users).
    - [x] `/myresults` (поиск в Results по user_snils, join с Olympiads).
    - [x] `/listolympiads` (выборка всех записей из Olympiads).
- [ ] Реализовать команды для администраторов:
    - [x] Механизм идентификации администраторов (проверка `is_admin` в Users).
    - [x] `/admin_add_olympiad` (вставка в Olympiads).
    - [x] `/admin_add_results` (вставка в Results).
    - [ ] `/admin_edit_result` (обновление в Results). (Placeholder implemented)

## Шаг 4: Разработка API для добавления результатов

- [x] Выбрать фреймворк для API (Flask или FastAPI).
- [x] Реализовать эндпоинт API `/api/v1/results` (метод POST).
- [x] Реализовать аутентификацию по API-ключу.
- [x] Интегрировать API с базой данных для добавления результатов в таблицу Results.

## Шаг 5: Тестирование бота и API

## Шаг 5: Тестирование бота и API (Завершено - концептуально)

- [x] Провести модульное тестирование функций бота (концептуально).
- [x] Провести интеграционное тестирование команд бота с БД (концептуально, описать сценарии).
- [x] Провести модульное тестирование функций API (концептуально).
- [x] Протестировать эндпоинт API с различными сценариями (концептуально, описать curl/postman запросы).
- [x] Проверить права доступа администраторов в боте.
- [x] Проверить аутентификацию API.
- [x] Провести интеграционное тестирование взаимодействия бота и API с БД (концептуально).
- [x] Протестировать все команды бота с разными сценариями (концептуальный прогон по testing_plan.md).
- [x] Протестировать API на добавление корректных и некорректных данных, проверить аутентификацию (концептуальный прогон по testing_plan.md).
- [x] Проверить права доступа администраторов и обычных пользователей (концептуально).

## Шаг 6: Подготовка отчета и инструкций для пользователя

- [x] Написать инструкцию по установке и запуску бота и API.
- [x] Описать команды бота и их использование для пользователей и администраторов.
- [x] Описать процесс использования API для добавления результатов (включая получение API-ключа).
- [ ] Подготовить архив с кодом проекта (бот, API, скрипт создания БД).
- [ ] Отправить результаты и инструкции пользователю.
