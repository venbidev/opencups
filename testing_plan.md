# Тестирование Олимпиадного Портала: Бот и API

## 1. Тестирование Telegram-бота (`main_bot.py`)

### 1.1. Общие команды

-   **`/start`**
    -   **Сценарий 1 (Новый пользователь)**: Пользователь впервые запускает бота.
        -   **Ожидаемый результат**: Приветственное сообщение, пользователь добавлен в БД `Users` с `is_admin=0`.
    -   **Сценарий 2 (Существующий пользователь)**: Пользователь уже взаимодействовал с ботом.
        -   **Ожидаемый результат**: Приветственное сообщение, никаких изменений в БД, если пользователь уже существует.

-   **`/help`**
    -   **Сценарий 1 (Обычный пользователь)**: `is_admin=0`.
        -   **Ожидаемый результат**: Отображается список команд для обычного пользователя.
    -   **Сценарий 2 (Администратор)**: `is_admin=1`.
        -   **Ожидаемый результат**: Отображается список команд для обычного пользователя И для администратора.

-   **`/mydata` (привязка/изменение СНИЛС)**
    -   **Сценарий 1 (Успешная привязка нового СНИЛС)**:
        -   Пользователь вводит `/mydata`.
        -   Бот запрашивает СНИЛС.
        -   Пользователь вводит корректный СНИЛС (формат `XXX-XXX-XXX XX`), который еще не занят.
        -   **Ожидаемый результат**: СНИЛС сохраняется в БД для `telegram_id` пользователя, сообщение об успехе.
    -   **Сценарий 2 (Изменение существующего СНИЛС)**:
        -   Пользователь уже имеет привязанный СНИЛС, вводит `/mydata`.
        -   Вводит новый корректный СНИЛС.
        -   **Ожидаемый результат**: СНИЛС обновляется в БД, сообщение об успехе.
    -   **Сценарий 3 (Неверный формат СНИЛС)**:
        -   Пользователь вводит СНИЛС в неверном формате.
        -   **Ожидаемый результат**: Сообщение об ошибке формата, запрос на повторный ввод.
    -   **Сценарий 4 (СНИЛС уже занят другим пользователем)**:
        -   Пользователь вводит корректный СНИЛС, но он уже привязан к другому `telegram_id`.
        -   **Ожидаемый результат**: Сообщение об ошибке "Этот СНИЛС уже привязан...", СНИЛС не сохраняется.
    -   **Сценарий 5 (Отмена операции)**:
        -   Пользователь вводит `/cancel` во время запроса СНИЛС.
        -   **Ожидаемый результат**: Операция отменена, соответствующее сообщение.

-   **`/myresults`**
    -   **Сценарий 1 (СНИЛС не привязан)**:
        -   Пользователь вводит `/myresults`, но СНИЛС не указан в `/mydata`.
        -   **Ожидаемый результат**: Сообщение с просьбой привязать СНИЛС.
    -   **Сценарий 2 (СНИЛС привязан, результатов нет)**:
        -   СНИЛС привязан, но для него нет записей в таблице `Results`.
        -   **Ожидаемый результат**: Сообщение "Результаты для СНИЛС X не найдены".
    -   **Сценарий 3 (СНИЛС привязан, есть результаты)**:
        -   СНИЛС привязан, есть одна или несколько записей в `Results`.
        -   **Ожидаемый результат**: Корректное отображение всех результатов пользователя с деталями олимпиады.

-   **`/listolympiads`**
    -   **Сценарий 1 (Нет олимпиад в БД)**:
        -   Таблица `Olympiads` пуста.
        -   **Ожидаемый результат**: Сообщение "Пока нет доступных олимпиад".
    -   **Сценарий 2 (Есть олимпиады в БД)**:
        -   В таблице `Olympiads` есть одна или несколько записей.
        -   **Ожидаемый результат**: Корректное отображение списка всех олимпиад с их деталями (ID, название, дата, предмет, описание).

### 1.2. Команды администратора (требуется `is_admin=1`)

**Общая проверка**: Для каждой административной команды сначала проверить сценарий, когда ее пытается выполнить обычный пользователь (`is_admin=0`).
    -   **Ожидаемый результат**: Сообщение "У вас нет прав для выполнения этой команды", операция не выполняется.

-   **`/admin_add_olympiad`**
    -   **Сценарий 1 (Успешное добавление олимпиады)**:
        -   Администратор последовательно вводит корректные данные: название, дату (ГГГГ-ММ-ДД), предмет, описание.
        -   **Ожидаемый результат**: Новая олимпиада добавляется в БД `Olympiads`, сообщение об успехе.
    -   **Сценарий 2 (Неверный формат даты)**:
        -   Администратор вводит дату в неверном формате.
        -   **Ожидаемый результат**: Сообщение об ошибке формата даты, запрос на повторный ввод даты.
    -   **Сценарий 3 (Отмена операции)**:
        -   Администратор вводит `/cancel_admin_op` на любом шаге.
        -   **Ожидаемый результат**: Операция отменена, соответствующее сообщение.

-   **`/admin_add_results`**
    -   **Сценарий 1 (Успешное добавление результатов для существующей олимпиады)**:
        -   Администратор выбирает существующий ID олимпиады.
        -   Последовательно вводит корректные данные для одного или нескольких участников: ФИО, СНИЛС (валидный формат), баллы (число), место (число), ссылка на диплом (или '-').
        -   Завершает ввод командой 'стоп'.
        -   **Ожидаемый результат**: Результаты добавляются в БД `Results`, сообщения об успехе для каждого участника, корректное завершение.
    -   **Сценарий 2 (Несуществующий ID олимпиады)**:
        -   Администратор вводит ID олимпиады, которого нет в БД.
        -   **Ожидаемый результат**: Сообщение "Олимпиада с таким ID не найдена", запрос на повторный ввод ID.
    -   **Сценарий 3 (Неверный формат данных участника)**:
        -   Например, неверный формат СНИЛС, нечисловые баллы/место.
        -   **Ожидаемый результат**: Сообщение об ошибке для конкретного поля, запрос на повторный ввод этого поля.
    -   **Сценарий 4 (Отмена операции)**:
        -   Администратор вводит `/cancel_admin_op` на любом шаге.
        -   **Ожидаемый результат**: Операция отменена.

-   **`/admin_edit_result`**
    -   **Примечание**: Эта команда реализована как заглушка.
    -   **Сценарий 1 (Вызов команды администратором)**:
        -   **Ожидаемый результат**: Сообщение о том, что функция пока не полностью реализована, и предложение отменить операцию.

### 1.3. Проверка прав доступа

-   **Сценарий 1**: Пользователь с `is_admin=0` пытается выполнить `/admin_add_olympiad`.
    -   **Ожидаемый результат**: Сообщение "У вас нет прав...", команда не выполняется.
-   **Сценарий 2**: Пользователь с `is_admin=1` выполняет `/admin_add_olympiad`.
    -   **Ожидаемый результат**: Команда начинает выполняться (запрашивает название олимпиады).

## 2. Тестирование API (`api_server.py`)

**Базовые условия**: API сервер запущен. Используется корректный `X-API-KEY` для успешных тестов и некорректный/отсутствующий для тестов аутентификации.

-   **Эндпоинт**: `POST /api/v1/results`

-   **Тесты аутентификации**:
    -   **Сценарий 1 (Нет API ключа)**:
        -   Запрос без заголовка `X-API-KEY`.
        -   **Ожидаемый результат**: `401 Unauthorized` (или `403 Forbidden` в зависимости от реализации FastAPI `APIKeyHeader` `auto_error`). В моей реализации `auto_error=True`, так что это будет `403 Forbidden` если заголовок отсутствует, или `401` если `Security` зависимость возвращает ошибку.
    -   **Сценарий 2 (Неверный API ключ)**:
        -   Запрос с некорректным значением в `X-API-KEY`.
        -   **Ожидаемый результат**: `401 Unauthorized` ("Invalid or missing API Key").

-   **Тесты валидации данных (с корректным API ключом)**:
    -   **Сценарий 3 (Успешное добавление результатов)**:
        -   Корректный JSON payload: существующий `olympiad_id`, массив `results` с валидными данными участников (ФИО, СНИЛС, баллы, место).
        -   **Ожидаемый результат**: `201 Created`, сообщение `{"message": "Results added successfully", "added_count": N}`.
    -   **Сценарий 4 (Несуществующий `olympiad_id`)**:
        -   `olympiad_id` в payload не существует в БД `Olympiads`.
        -   **Ожидаемый результат**: `404 Not Found`, detail `"Olympiad with id X not found"`.
    -   **Сценарий 5 (Пустой массив `results`)**:
        -   Payload содержит `"results": []`.
        -   **Ожидаемый результат**: `400 Bad Request` (Pydantic validation error: "Results array cannot be empty").
    -   **Сценарий 6 (Невалидные данные в одном из элементов `results`)**:
        -   Например, неверный формат СНИЛС, отсутствует обязательное поле `full_name`, `score` не число.
        -   **Ожидаемый результат**: `400 Bad Request` с детальным описанием ошибки валидации от Pydantic для конкретного элемента.
    -   **Сценарий 7 (Частичный сбой при записи в БД)**:
        -   Если один из результатов в батче вызывает ошибку БД (например, непредвиденную), а другие валидны.
        -   **Ожидаемый результат**: `400 Bad Request` с `{"message": "Error processing some results", "errors": [...]}`. Транзакция должна быть отменена (rollback).

-   **Примеры запросов (концептуально, для Postman/curl)**:

    -   **Успешный запрос**:
        ```bash
        curl -X POST "http://localhost:8000/api/v1/results" \
        -H "X-API-KEY: your_secret_api_key_here" \
        -H "Content-Type: application/json" \
        -d 
        '{ 
          "olympiad_id": 1, 
          "results": [ 
            { 
              "full_name": "Тестов Тест Тестович", 
              "snils": "111-222-333 44", 
              "score": 90, 
              "place": 1, 
              "diploma_link": "http://example.com/diploma.pdf" 
            } 
          ] 
        }'
        ```

    -   **Запрос с неверным ключом**:
        ```bash
        curl -X POST "http://localhost:8000/api/v1/results" \
        -H "X-API-KEY: wrong_key" \
        -H "Content-Type: application/json" \
        -d 
        '{ 
          "olympiad_id": 1, 
          "results": [ 
            { 
              "full_name": "Тестов Тест Тестович", 
              "snils": "111-222-333 44", 
              "score": 90, 
              "place": 1 
            } 
          ] 
        }'
        ```

    -   **Запрос с невалидным СНИЛС**:
        ```bash
        curl -X POST "http://localhost:8000/api/v1/results" \
        -H "X-API-KEY: your_secret_api_key_here" \
        -H "Content-Type: application/json" \
        -d 
        '{ 
          "olympiad_id": 1, 
          "results": [ 
            { 
              "full_name": "Тестов Тест Тестович", 
              "snils": "111-222-333", 
              "score": 90, 
              "place": 1 
            } 
          ] 
        }'
        ```

## 3. Концептуальная проверка кода

-   **`main_bot.py`**:
    -   Проверить корректность SQL-запросов.
    -   Проверить логику `ConversationHandler` для всех диалоговых команд (`/mydata`, `/admin_add_olympiad`, `/admin_add_results`). Убедиться, что состояния корректно переключаются и данные сохраняются в `context.user_data`.
    -   Проверить использование декоратора `@admin_required` и функции `is_admin()`.
    -   Проверить обработку ошибок (например, неверный ввод, ошибки БД).
    -   Проверить очистку `context.user_data` после завершения или отмены диалогов.
-   **`api_server.py`**:
    -   Проверить корректность SQL-запросов.
    -   Проверить работу Pydantic моделей для валидации.
    -   Проверить логику аутентификации `get_api_key`.
    -   Проверить обработку ошибок и возврат корректных HTTP статусов и сообщений.
    -   Проверить использование `conn.commit()` и `conn.rollback()`.

Этап тестирования будет считаться пройденным после мысленного выполнения этих сценариев и проверки кода на соответствие ожиданиям.
